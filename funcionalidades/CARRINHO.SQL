
--======================================CARRINHO==========================================--
-- REGISTRAR CARRINHO
CREATE OR REPLACE FUNCTION CRIAR_NOVO_CARRINHO(CLIENT_ID INT)
RETURNS INT AS $$
DECLARE
    CARRINHO_ID INT;
BEGIN
    INSERT INTO CARRINHO(ID_CLIENTE)
    VALUES (CLIENT_ID) RETURNING ID_CARRINHO INTO CARRINHO_ID;

    RETURN CARRINHO_ID;
END;
$$ LANGUAGE PLPGSQL;



-- VERIFICAR COMPRA DUPLICADA trigger
CREATE OR REPLACE FUNCTION PRODUTO_JA_NO_CARRINHO() RETURNS TRIGGER AS $$
DECLARE
    PRODUTO_ESTA_NO_CARRINHO BOOLEAN;
    QTD_MAIS_QTD_CARRINHO INT;
    HA_ESTOQUE BOOLEAN;
    ITEM_CARRINHO_ID INT;
BEGIN
    SELECT COUNT(ID_ITEM_CARRINHO) > 0 FROM ITEM_CARRINHO 
    WHERE ID_PRODUTO_LOJA = NEW.ID_PRODUTO_LOJA AND ID_CARRINHO = NEW.ID_CARRINHO 
    INTO PRODUTO_ESTA_NO_CARRINHO;

    IF (PRODUTO_ESTA_NO_CARRINHO = TRUE) THEN
        SELECT QUANTIDADE FROM ITEM_CARRINHO 
        WHERE ID_PRODUTO_LOJA = NEW.ID_PRODUTO_LOJA AND ID_CARRINHO = NEW.ID_CARRINHO 
        INTO QTD_MAIS_QTD_CARRINHO;

        QTD_MAIS_QTD_CARRINHO := QTD_MAIS_QTD_CARRINHO + NEW.QUANTIDADE;
        HA_ESTOQUE := VERIFICAR_ESTOQUE_DO_PRODUTO(PRODUTO_LOJA_ID, QTD_MAIS_QTD_CARRINHO);

        IF (HA_ESTOQUE = TRUE) THEN
            SELECT ID_ITEM_CARRINHO FROM ITEM_CARRINHO 
            WHERE ID_PRODUTO_LOJA = NEW.ID_PRODUTO_LOJA AND ID_CARRINHO = NEW.ID_CARRINHO 
            INTO ITEM_CARRINHO_ID;

            UPDATE ITEM_CARRINHO
            SET QUANTIDADE = QTD_MAIS_QTD_CARRINHO
            WHERE ID_ITEM_CARRINHO = ITEM_CARRINHO_ID;
            RAISE INFO 'PRODUTO ADICIONADO AO CARRINHO (ADICIONADO A QUANTIDADE JÁ EXISTENTE)';
            RETURN;
        ELSE
            RAISE EXCEPTION 'IMPOSSÍVEL ADICIONAR AO CARRINHO, O PRODUTO JÁ ESTÁ NO CARRINHO'
                            'E A QUANTIDADE INFORMADA SOMADA À QUANTIDADE DO CARRINHO É MAIOR'
                            'A QUANTIDADE DISPONÍVEL EM ESTOQUE';
        END IF;
    ELSE
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE PLPGSQL;

CREATE TRIGGER ADD_ITEM BEFORE INSERT OR UPDATE ON ITEM_CARRINHO FOR EACH ROW EXECUTE PRODUTO_JA_NO_CARRINHO();


-- VERIFICAR CARRINHO
CREATE OR REPLACE FUNCTION HA_PRODUTOS_NO_CARRINHO_DO_CLIENTE(CLIENTE_ID INT) 
RETURNS BOOLEAN AS $$
DECLARE
    CARRINHO_ENCONTRADO INT;
    QTD_PRODUTOS_NO_CARRINHO INT;
BEGIN

    SELECT COUNT(CAR.ID_CARRINHO) FROM CLIENTE CLI
    INNER JOIN CARRINHO CAR ON CLI.ID_CLIENTE = CAR.ID_CLIENTE
    WHERE CLI.ID_CLIENTE = CLIENTE_ID
    INTO CARRINHO_ENCONTRADO;

    IF (CARRINHO_ENCONTRADO = 0) THEN
        RAISE EXCEPTION 'NÃO EXISTE CARRINHO PARA O CLIENTE INFORMADO';
    ELSE
        SELECT COUNT(CAR.ID_CARRINHO) FROM CLIENTE CLI
        INNER JOIN CARRINHO CAR ON CLI.ID_CLIENTE = CAR.ID_CLIENTE
        INNER JOIN ITEM_CARRINHO ITEM_CAR ON CAR.ID_CARRINHO = ITEM_CAR.ID_CARRINHO
        WHERE CLI.ID_CLIENTE = CLIENTE_ID
        INTO QTD_PRODUTOS_NO_CARRINHO;

        IF (QTD_PRODUTOS_NO_CARRINHO = 0) THEN
            RAISE EXCEPTION 'NÃO HÁ PRODUTOS NO CARRINHO DO CLIENTE INFORMADO';
        ELSE
            RETURN TRUE;
        END IF;
    END IF;

    RETURN FALSE;
END;
$$ LANGUAGE PLPGSQL;




--=========================================ITEM=========================================--
CREATE OR REPLACE FUNCTION ADICIONAR_PRODUTO_AO_CARRINHO(PRODUTO_LOJA_ID INT, CLIENT_ID INT, QTD INT)
RETURNS VOID AS $$
DECLARE
    CARRINHO_ID INT;
    HA_ESTOQUE BOOLEAN;
    ITEM_CARRINHO_ID INT;
BEGIN

    CARRINHO_ID := (RECUPERAR_CARRINHO_DO_USUÁRIO(CLIENT_ID));
    HA_ESTOQUE := (VERIFICAR_ESTOQUE_DO_PRODUTO(PRODUTO_LOJA_ID, QTD));

    IF (HA_ESTOQUE = FALSE) THEN
        RAISE EXCEPTION 'QUANTIDADE INFORMADA NÃO DISPONÍVEL EM ESTOQUE';
    ELSE
        INSERT INTO ITEM_CARRINHO (ID_PRODUTO_LOJA, ID_CARRINHO, QUANTIDADE)
        VALUES (PRODUTO_LOJA_ID, CARRINHO_ID, QTD);
        RAISE INFO 'PRODUTO ADICIONADO AO CARRINHO';
    END IF;
    
END;
$$ LANGUAGE PLPGSQL;

CREATE OR REPLACE FUNCTION ADICIONAR_AO_CARRINHO(PRODUTO VARCHAR, CLIENT VARCHAR, QTD INT)
RETURNS VOID AS $$
DECLARE
    PRODUTO_LOJA_ID INT;
    CLIENT_ID INT;
BEGIN
    PRODUTO_LOJA_ID := ;
    CLIENT_ID := SELECIONAR_ID_CLIENTE_POR_USUARIO(CLIENT);
    PERFORM ADICIONAR_PRODUTO_AO_CARRINHO(PRODUTO_LOJA_ID, CLIENT_ID, QTD);
END;
$$ LANGUAGE PLPGSQL;


CREATE OR REPLACE FUNCTION RECUPERAR_CARRINHO_DO_USUÁRIO(CLIENT_ID INT)
RETURNS INT AS $$
DECLARE
    CARRINHO_ENCONTRADO INT;
    CARRINHO_ID INT;
BEGIN

    SELECT COUNT(ID_CARRINHO) FROM CARRINHO 
    WHERE ID_CLIENTE = CLIENT_ID 
    INTO CARRINHO_ENCONTRADO;

    IF (CARRINHO_ENCONTRADO = 1) THEN
        SELECT ID_CARRINHO FROM CARRINHO 
        WHERE ID_CLIENTE = CLIENT_ID 
        INTO CARRINHO_ID;
    ELSE
        CARRINHO_ID := (CRIAR_NOVO_CARRINHO(CLIENT_ID));
    END IF;

    RETURN CARRINHO_ID;

END;
$$ LANGUAGE PLPGSQL;


CREATE OR REPLACE FUNCTION RECUPERAR_ID_ITEM_CARRINHO(PRODUTO_LOJA_ID INT, CARRINHO_ID INT) 
RETURNS INT AS $$
DECLARE
    ITEM_CARRINHO_ID INT;
BEGIN

    SELECT ID_ITEM_CARRINHO FROM ITEM_CARRINHO 
    WHERE ID_PRODUTO_LOJA = PRODUTO_LOJA_ID AND ID_CARRINHO = CARRINHO_ID
    INTO ITEM_CARRINHO_ID;

    RETURN ITEM_CARRINHO_ID;

END;
$$ LANGUAGE PLPGSQL;



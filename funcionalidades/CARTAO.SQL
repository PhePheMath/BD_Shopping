

--======================================CARTAO===========================================--
-- REGISTRAR CARTÃO
CREATE OR REPLACE FUNCTION ADICIONAR_CARTAO_AO_PERFIL(
	TITULAR VARCHAR,
	DIGITOS VARCHAR,
	VALIDADE VARCHAR,
	CSV VARCHAR,
	SAVE BOOLEAN,
	USUARIO VARCHAR
) RETURNS VOID AS $$
DECLARE 
	IS_SAVE BOOLEAN;
	ID_CLIENTE INTEGER;
BEGIN 
	IF (TITULAR IS NULL) THEN
		RAISE EXCEPTION 'INFORME O TITULAR DO CARTAO';
	ELSIF (DIGITOS IS NULL) THEN
		RAISE EXCEPTION 'INFORME OS DIGITOS DO CARTAO';
	ELSIF (VALIDADE IS NULL) THEN
		RAISE EXCEPTION 'INFORME A VALIDADE DO CARTAO';
	ELSIF (CSV IS NULL) THEN
		RAISE EXCEPTION 'INFORME O CSV DO CARTAO';
	ELSIF (USUARIO IS NULL) THEN
		RAISE EXCEPTION 'INFORME O USUÁRIO DONO DO CARTAO';
	-- REGRAS DE NEGOCIO
	ELSIF (LENGTH(DIGITOS) != 4) THEN
		RAISE EXCEPTION 'DIGITO DEVE CONTER 4 CARACTERES';
	ELSIF (LENGTH(VALIDADE) != 5) THEN
		RAISE EXCEPTION 'VALIDADE DEVE CONTER 5 CARACTERES';
	ELSIF (SAVE IS NULL) THEN
		IS_SAVE = FALSE;
	ELSE
		ID_CLIENTE := SELECIONAR_ID_CLIENTE_POR_USUARIO(USUARIO);
		
		IF (ID_CLIENTE IS NULL) THEN
			RAISE EXCEPTION 'USUARIO NAO CADASTRADO, VERIFIQUE O USUARIO INFORMADO E TENTE NOVAMENTE';
		ELSE
			INSERT INTO CARD(TITULAR, DIGITOS, VALIDADE, CSV, SAVE, ID_CLIENTE)
			VALUES (TITULAR, DIGITOS, VALIDADE, CSV, IS_SAVE, ID_CLIENTE);
			RAISE INFO 'CARTAO ADICIONADO COM SUCESSO AO CLIENTE';
		END IF;
	END IF;
END $$ LANGUAGE PLPGSQL;


-- VERIFICAR CARTÃO
